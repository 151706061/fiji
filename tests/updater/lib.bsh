// A library of useful variables and functions

if (hidden == void) // not defined?
	hidden = true;

/// SETUP

testDir = libDir.getCanonicalFile().getParentFile();
tmpDeveloperRoot = new File(testDir, "tmpDeveloperRoot");
tmpUserRoot = new File(testDir, "tmpUserRoot");
tmpWebRoot = new File(testDir, "tmpWebRoot");

import fiji.updater.Updater;

import fiji.updater.logic.PluginObject;

import fiji.updater.util.Util;

Updater.MAIN_URL = "file:" + tmpWebRoot.getAbsolutePath() + "/";
Updater.UPDATE_DIRECTORY = tmpWebRoot.getAbsolutePath() + "/";

if (Util.isDeveloper)
	Updater.SSH_HOST = null;


/// GENERAL HELPERS

error(message) {
	throw new RuntimeException(message);
}

assert(message, cond) {
	if (!cond)
		error("assertion failed: " + message);
}


/// DATA STRUCTURE HELPERS

shiftArray(array) {
	newArray = new String[array.length - 1];
	System.arraycopy(array, 1, newArray, 0, newArray.length);
	return newArray;
}

unshiftArray(array, item) {
	newArray = new String[array.length + 1];
	newArray[0] = item;
	System.arraycopy(array, 0, newArray, 1, array.length);
	return newArray;
}

appendArray(array, array2) {
	newArray = new String[array.length + array2.length];
	System.arraycopy(array, 0, newArray, 0, array.length);
	System.arraycopy(array2, 0, newArray, array.length, array2.length);
	return newArray;
}

count(iterable) {
	i = 0;
	for (iter = iterable.iterator(); iter.hasNext(); i++)
		iter.next();
	return i;
}

requireStatus(filename, status) {
	assert(filename + " has status " + status,
		plugins.getPlugin(filename).getStatus() == status);
}

markForUpload(filename) {
	print("Marking " + filename + " for upload");
	plugins.getPlugin(filename).setAction(plugins, PluginObject.Action.UPLOAD);
}


/// FILESYSTEM HELPERS

deleteRecursively(dir) {
	for (File file : dir.listFiles())
		if (file.getName().equals(".") || file.getName().equals(".."))
			continue;
		else if (file.isDirectory())
			deleteRecursively(file);
		else if (file.isFile())
			file.delete();
	dir.delete();
}

import fiji.updater.util.UpdateJava;

import java.io.FileInputStream;

copyFile(source, destination) {
	destination.getCanonicalFile().getParentFile().mkdirs();
	new UpdateJava().copyTo(new FileInputStream(source), destination.getAbsolutePath());
	if (destination.getName().equals("fiji"))
		execute(new String[] { "chmod", "a+x", destination.getAbsolutePath() });
}

fijiDir = new File(System.getProperty("fiji.executable")).getCanonicalFile().getParentFile();

prepareNewFijiRoot(root, asDeveloper) {
	if (root.exists())
		deleteRecursively(root);
	root.mkdirs();

	toCopy = new String[] {
		"fiji",
		"jars/ij.jar", "jars/Fiji.jar", "plugins/Fiji_Updater.jar",
		"jars/bsh-2.0b4.jar", "jars/jsch-0.1.37.jar"
	};

	if (asDeveloper)
		toCopy = unshiftArray(toCopy, "fiji.c");

	for (String name : toCopy)
		copyFile(new File(fijiDir, name),  new File(root, name));
}

import fiji.updater.util.Compressor;

readFile(dir, name) {
	in = new FileInputStream(new File(dir, name));
	return new String(Compressor.readStream(in)).trim();
}

import java.io.PrintWriter;

writeFile(dir, name) {
	return writeFile(dir, name,name);
}

writeFile(dir, name, content) {
	file = new File(dir, name);
	file.getParentFile().mkdirs();
	writer = new PrintWriter(file);
	writer.println(content);
	writer.close();

	return file;
}

cleanWebRoot() {
	if (tmpWebRoot.exists())
		deleteRecursively(tmpWebRoot);
	tmpWebRoot.mkdirs();

	dbXml = writeFile(tmpWebRoot, "db.xml",
		"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"
		+ "<pluginRecords/>");

	execute(new String[] { "gzip", dbXml.getAbsolutePath() });
}


// JAR HELPERS

import java.io.ByteArrayInputStream;
import java.io.FileOutputStream;

import java.util.Collections;

import java.util.jar.JarEntry;
import java.util.jar.JarFile;
import java.util.jar.JarOutputStream;

copyStream(in, out) {
	byte[] buffer = new byte[16384];
	for (;;) {
		int count = in.read(buffer);
		if (count < 0)
			break;
		out.write(buffer, 0, count);
	}
	in.close();
}

addToJar(path, filename, contents) {
	if (!(path instanceof File))
		path = new File(path);
	newPath = new File(path.getAbsolutePath() + ".new");
	input = new JarFile(path);
	output = new JarOutputStream(new FileOutputStream(newPath));
	for (JarEntry entry : Collections.list(input.entries()))
		if (!entry.getName().equals(filename)) {
			output.putNextEntry(entry);
			copyStream(input.getInputStream(entry), output);
		}
	output.putNextEntry(new JarEntry(filename));
	if (!(contents instanceof byte[]))
		contents = contents.getBytes();
	copyStream(new ByteArrayInputStream(contents), output);
	output.close();
	if (!path.delete() || !newPath.renameTo(path))
		throw new Exception("Could not rename " + newPath + " to " + path);
}


/// LAUNCH HELPERS

import fiji.SimpleExecuter;

execute(args) {
	lineHandler = new SimpleExecuter.LineHandler() {
		handleLine(line) {
			print(line);
		}
	};
	executer = new SimpleExecuter(args, lineHandler, lineHandler);
	status = executer.getExitCode();
	if (status != 0) {
		print("Failed with error " + status);
		System.exit(status);
	}
}

startFiji(root, type, bsh) {
	args = new String[] {
		new File(root, "fiji").getAbsolutePath(),
		"--java-home=" + System.getProperty("java.home"),
		new File(libDir, "client.bsh").getAbsolutePath(),
		bsh,
		hidden ? "" : "--no-hidden"
	};
	print("Starting fake " + type + " with " + bsh);
	execute(args);
}

upload(bsh) {
	startFiji(tmpDeveloperRoot, "developer", bsh);
}

download(bsh) {
	startFiji(tmpUserRoot, "user", bsh);
}


/// GUI INTERACTION HELPERS

// waitForWindow (not fiji.Main's, because we're interested even in non-showing windows

import java.awt.AWTEvent;
import java.awt.Dialog;
import java.awt.Frame;
import java.awt.Tookit;

import java.awt.event.AWTEventListener;
import java.awt.event.WindowEvent;

import java.util.HashMap;
import java.util.HashSet;

windowMap = null;

public class WindowCollector implements AWTEventListener {
	public void eventDispatched(AWTEvent event) {
		source = event.getSource();
		if ((source instanceof Dialog || source instanceof Frame) && source.getTitle() != null) {
			if (!source.getTitle().equals("ImageJA") && source.getWidth() == 0) // make sure pack() has been called on the window
				return;
			if (discardedWindows.contains(source))
				return;
			title = source.getTitle();
			if (event.getID() == WindowEvent.WINDOW_CLOSED) {
				synchronized (windowMap) {
					discardedWindows.add(windowMap.get(title));
					windowMap.remove(title);
					windowMap.notifyAll();
				}
				return;
			}
			if (!hidden && !source.isVisible())
				return;
			synchronized (windowMap) {
				if (!windowMap.containsKey(title) || windowMap.get(title) != source) {
					windowMap.put(title, source);
					windowMap.notifyAll();
				}
			}
		}
	}
}

waitForWindow(title) {
	if (windowMap == null) {
		windowMap = new HashMap();
		global.discardedWindows = new HashSet();
		Toolkit.getDefaultToolkit().addAWTEventListener(new WindowCollector(), -1);
	}
	synchronized (windowMap) {
		for (;;) {
			if (windowMap.containsKey(title))
				return windowMap.get(title);
			windowMap.wait();
		}
	}
}

import java.awt.Window;

describeComponent(component) {
	className = component.getClass().getName();
	result = className.substring(className.lastIndexOf('.') + 1);
	if (component instanceof Window)
		result += "(" + component.getTitle() + ")";
	return result;
}

listComponentsRecursively(container) {
	listComponentsRecursively(container, "");
}

import java.awt.Component;
import java.awt.Container;

listComponentsRecursively(component, indent) {
	print(indent + describeComponent(component));
	if (component instanceof Container)
		for (Component child : component.getComponents())
			listComponentsRecursively(child, indent + "\t");
}

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

getButton(container, title) {
	for (Component child : container.getComponents())
		if (child instanceof JButton && child.getText().equals(title))
			return child;
		else if (child instanceof Container) {
			button = getButton(child, title);
			if (button != null)
				return button;
		}
	return null;
}

clickButton(container, title) {
	button = getButton(container, title);
	if (button == null)
		error("Button " + title + " not found in " + container);
	/*
	child.addActionListener(new ActionListener() {
		void actionPerformed(ActionEvent e) {
			print(e.getActionCommand());
			print(e.getID());
		}
	});
	*/
	// The button must be clicked after the dialog was initialized
	// (otherwise the value set by the "OK" button is ignored)
	if (!hidden) {
		window = container;
		while (window != null && !(window instanceof Window))
			window = window.getParent();
		while (!window.isActive())
			Thread.sleep(50);
	}
	event = new ActionEvent(button, ActionEvent.ACTION_PERFORMED, button.getText());
	for (ActionListener listener : button.getActionListeners())
		listener.actionPerformed(event);
	if (hidden) {
		while (container != null)
			if (container instanceof Window) {
				container.dispose();
				break;
			}
			else
				container = container.getParent();
	}
}

import ij.IJ;

startUpdater() {
	// The window is called ImageJA when being created
	waitForWindow("ImageJA");
	if (hidden)
		Updater.hidden = true;
	new Thread() {
		public void run() {
			IJ.run("Update Fiji");
		}
	}.start();
	print("Waiting for the updater");
	global.updaterFrame = waitForWindow("Fiji Updater");
	print("Got the updater");
	setAccessibility(true);
	global.plugins = updaterFrame.plugins;
}

import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;

waitUntilClosed(window) {
	print("Waiting until " + window.getTitle() + " is closed");
	synchronized (windowMap) {
		while (windowMap.get(window.getTitle()) == window)
			windowMap.wait();
	}
	print(window.getTitle() + " was closed");
}

import javax.swing.JOptionPane;

getOptionPane(container) {
	for (Component child : container.getComponents())
		if (child instanceof JOptionPane)
			return child;
		else if (child instanceof Container) {
			pane = getOptionPane(child);
			if (pane != null)
				return pane;
		}
	return null;
}

waitForMessageBox(title, message) {
	print("Waiting for the " + title + " '" + message + "'");
	window = waitForWindow(title);
	pane = getOptionPane(window);
	if (pane.getMessage().equals(message)) {
		clickButton(window, "OK");
		window.dispose();
		print("Okay");
	}
	else
		print("Not okay (" + title + "): " + pane.getMessage() + " instead of " + message);
}

waitForInformation(message) {
	waitForMessageBox("Information", message);
}

waitForWarning(message) {
	waitForMessageBox("Warning", message);
}

requireUpToDate() {
	waitForInformation("Your Fiji is up to date!");
}

requireUploadOK() {
	waitForInformation("Uploaded successfully.");
}

requireDownloadFinished() {
	waitForInformation("Updated successfully.  Please restart Fiji!");
}

requireModified() {
	waitForWarning("There are locally modified files!");
}

requireQuestion(title, question) {
	print("Waiting for the question " + title + " '" + question + "'");
	window = waitForWindow(title);
	pane = getOptionPane(window);
	if (pane.getMessage().equals(question)) {
		if (getButton(pane, "Yes") != null)
			clickButton(pane, "Yes");
		else
			clickButton(pane, "OK");
		//pane.setValue(new Integer(JOptionPane.YES_OPTION));
		//window.dispose();
		print("Okay");
	}
	else
		print("Not okay (" + title + "): " + pane.getMessage() + " instead of " + question);
}

requireUpdateUpdaterQuestion() {
	requireQuestion("Update the updater",
		"There is an update available for the Fiji Updater. Install now?");
}

advancedMode() {
	//listComponentsRecursively(updaterFrame);
	clickButton(updaterFrame, "Advanced mode");
}

viewMode(label) {
	if (!label.startsWith("View "))
		label = "View " + label;
	options = updaterFrame.viewOptions;
	selected = false;
	for (i = 0; i < options.getItemCount(); i++)
		if (options.getItemAt(i).toString().equals(label)) {
			options.setSelectedIndex(i);
			selected = true;
			break;
		}
	assert(label, selected);
}

exitWhenClosed() {
	waitUntilClosed(updaterFrame);
	System.exit(0);
}

startUpload() {
	print("Uploading");
	clickButton(updaterFrame, "Upload to server");
	requireUploadOK();
	exitWhenClosed();
}

startDownload() {
	print("Downloading");
	clickButton(updaterFrame, "Apply changes");
	requireDownloadFinished();
}


/// THE DEVELOPER/USER IMPERSONATIONS

initialUpload() {
	startUpdater();
	requireUpToDate();
	advancedMode();
	assert("5 plugins", plugins.size() == 5);
	for (PluginObject plugin : plugins)
		markForUpload(plugin.filename);
	startUpload();
}

initialUserCheck() {
	startUpdater();
	requireUpToDate();
	advancedMode();
	assert("5 plugins", plugins.size() == 5);
	for (PluginObject plugin : plugins)
		assert(plugin.filename + " is up-to-date",
			plugin.getStatus() == PluginObject.Status.INSTALLED);
	clickButton(updaterFrame, "Close");
	waitUntilClosed(updaterFrame);
	assert("db.xml.gz exists now", new File(tmpUserRoot, "db.xml.gz").exists());
	System.exit(0);
}

prepareSome() {
	print("Preparing some files");
	writeFile(tmpDeveloperRoot, "macros/new.ijm");
	writeFile(tmpDeveloperRoot, "macros/modified.ijm");
	writeFile(tmpUserRoot, "macros/modified.ijm", "modified");
}

uploadSome() {
	startUpdater();
	requireUpToDate();
	advancedMode();
	assert("7 plugins", plugins.size() == 7);
	markForUpload("macros/new.ijm");
	markForUpload("macros/modified.ijm");
	startUpload();
}

downloadSome() {
	startUpdater();
	requireModified();
	advancedMode();
	viewMode("all plugins");
	assert("7 plugins", plugins.size() == 7);
	assert("2 updateable", count(plugins.updateable(true)) == 2);
	assert("1 modified", count(plugins.locallyModified()) == 1);
	requireStatus("macros/modified.ijm", PluginObject.Status.MODIFIED);
	startDownload();
	assert("modified was left alone",
		!new File(tmpUserRoot, "update/macros/modified.ijm").exists());
	assert("new file was downloaded",
		readFile(tmpUserRoot, "update/macros/new.ijm").equals("macros/new.ijm"));
	System.exit(0);
}

prepareNewUpdater() {
	addToJar(new File(tmpDeveloperRoot, "plugins/Fiji_Updater.jar"),
		"timestamp", "Current time is " + Util.timestamp(System.currentTimeMillis()));
	writeFile(tmpDeveloperRoot, "macros/new2.ijm");
	writeFile(tmpDeveloperRoot, "macros/modified.ijm", "modified again");
	writeFile(tmpUserRoot, "macros/modified.ijm");
}

uploadNewUpdater() {
	startUpdater();
	requireModified();
	advancedMode();
	assert("8 plugins", count(plugins) == 8);
	assert("5 up-to-date", count(plugins.upToDate()) == 5);
	requireStatus("plugins/Fiji_Updater.jar", PluginObject.Status.MODIFIED);
	requireStatus("macros/new2.ijm", PluginObject.Status.NOT_FIJI);
	markForUpload("plugins/Fiji_Updater.jar");
	markForUpload("macros/new2.ijm");
	markForUpload("macros/modified.ijm");
	startUpload();
}

downloadNewUpdater() {
	dbXmlGz = new File(tmpUserRoot, "db.xml.gz");
	lastModified = dbXmlGz.lastModified();
	startUpdater();
	requireUpdateUpdaterQuestion();
	waitUntilClosed(updaterFrame);
	assert("db.xml.gz unmodified", lastModified == dbXmlGz.lastModified());
	startUpdater();
	while (count(plugins.upToDate()) != 6)
		Thread.sleep(500);
	advancedMode();
	assert("6 up-to-date", count(plugins.upToDate()) == 6);
	requireStatus("macros/modified.ijm", PluginObject.Status.UPDATEABLE);
	requireStatus("macros/new2.ijm", PluginObject.Status.NEW);
	startDownload();
	System.exit(0);
}